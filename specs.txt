--- Meshping 仕様整理 ---

■ 全体構成

- コンポーネント
  - 管理サーバ
  - 監視エージェント

■ 管理サーバの機能

1. WebSocket通信  
   - エージェントとの通信はWebSocketで実施。  
   - 通信はTLSで暗号化する前提。  
   - エージェントからの初回ハンドシェイクで認証情報を交換し、仮登録を実施。  
   - 再接続時、IPアドレスが変わった場合は自動認証するが「保留」状態とし、管理者による再承認を促す。

2. エージェント登録・認証  
   - 【パスフレーズ交換方式】  
     - 「新規エージェント登録画面」で、サーバ固有のパスフレーズ（暗号キー＋、IPアドレスを暗号化したもの）を表示。  
     - エージェントはパスフレーズを用いて、ホスト名、IPアドレス、バージョン等を暗号化して送信。  
     - 正しく復号できれば仮登録状態となり、管理者により承認（本登録）または拒否（ブラックリスト登録）する。  
   - 【承認後の管理】  
     - 承認されたエージェントにはシステム上でエージェントIDを割り振る。  
     - 管理情報（パスフレーズ、ホスト名、IPアドレス、バージョン）をSQLiteに保存。  
     - エージェントが再起動時等に再接続する際は自動認証、ただしIPアドレス変更の場合は保留状態とする。  
     - **新規:** エージェントは本登録時に管理サーバから監視対象リストを受け取り、その後サーバからのプッシュにより監視対象が更新される。

3. データベースとデータ保持  
   - 【DB】: SQLiteを使用し、監視データやエージェント情報を管理。  
   - 【監視データの保存】  
     - エージェントから5秒毎に監視データを送信。  
     - 監視データはSQLiteに保存すると共に、直近1時間分をメモリ上のキャッシュに保持し高速レスポンスを実現。  
     - キャッシュ外のデータリクエストがあった場合のみSQLiteからフェッチする。  
   - 【データリテンション】: 現時点では直近24時間分を保持（将来的に設定可能に拡張）。

4. 可視化Webサーバ  
   - 【管理ダッシュボード】  
     - エージェント一覧（承認待ち、承認済み、保留状態）を表示。  
     - エージェントの承認（承認ボタン）と拒否（拒否ボタン）機能。  
     - **新規:** 管理者は監視対象リストを一元管理し、必要に応じて更新。更新時は全エージェントにプッシュ配信する。  
     - **新規:** 監視対象リストの編集機能を提供。  
       管理者は対象IPの追加、編集、削除を行い、  
       変更時は全エージェントへプッシュ配信する。

   - 【リアルタイム監視画面】  
     - エージェントを行、監視対象を列とした秒単位の画面。  
     - 各セルは監視結果に応じ、OK＝緑、応答なし＝赤、レイテンシ高＝黄色で表示。  
   - 【ホバー表示】  
     - 各セルにマウスオーバーすると、直近1時間の監視結果（応答があればRTT、応答がなければ0）の線グラフを表示。

5. ユーザ管理  
   - 管理GUIで以下の機能を提供：  
     - 新規ユーザの登録  
     - 権限管理  
     - ログイン／ログアウト  
     - パスワードリセット

■ 監視エージェントの機能

- 【情報取得と報告】  
  - 管理サーバから監視対象（IPアドレス等）の情報を受信。  
  - 起動時・本登録時にパスフレーズを使用して、ホスト名、IPアドレス、バージョンなどの情報を登録し、同時に監視対象リストを受信。  
  - その後、サーバ側からの監視対象更新メッセージ（プッシュ）によりリストを更新する。

- 【ICMP監視】  
  - 複数の監視対象に対してICMPエコーリクエストを5秒毎に非同期で実施。  
  - 監視結果（応答状況、RTTなど）を収集し、エージェント内に最大30分間保持する揮発的バッファを用意する。  
  - 送信失敗が検知された場合、ローカルバッファから遅延送信を試みる。

- 【データ送信】  
  - WebSocketを介して、監視対象、監視時刻、結果のみを送信する。

- 【エラー処理】  
  - 通信路でのデータロスは下位プロトコルで再送保証の前提。  
  - サーバ側では再送処理を行わず、欠落があれば「エージェントとの接続不良」として表示。